<html>
    <head>
        <script>

            //coord -> [float, float]
            //returns City
            async function getCity(coords)
            {
                const latlng = 
                {
                    lat: coords[0],
                    lng: coords[1],
                };
                   
                return await new Promise((resolve, reject) =>
                {
                    geocoder.geocode({ location : latlng }, (results, status) => 
                    {
                        console.log(latlng);
                        if(status === 'OK') 
                        {
                            console.log(results[0]);
                            map.setCenter(results[0].geometry.location);
                            for(i = 0; i < results[0].address_components.length; i++)
                            {
                                if(results[0].address_components[i].types.includes("administrative_area_level_1"))
                                {
                                    resolve(results[0].address_components[i].long_name);
                                    return;
                                }
                                else if(results[0].address_components[i].types.includes("locality")) 
                                {
                                    resolve(results[0].address_components[i].long_name);
                                    return;
                                }
                                else if(results[0].address_components[i].types.includes("postal_town")) 
                                {
                                    resolve(results[0].address_components[i].long_name);
                                    return;
                                }
                            }
                            //var marker = new google.maps.Marker( {//map: map, position: results[0].geometry.location });
                            resolve("None");
                        } 
                        else 
                        {
                            console.log('Geocode failed: ' + status);
                            reject('Failed');
                        }
                    });
                });
            }

            //returns [float, float]
            async function getDeviceCoordinates()
            {
                return await new Promise((resolve, reject) => 
                {
                    navigator.geolocation.getCurrentPosition((location) => 
                    {
                        resolve([location.coords.latitude, location.coords.longitude]);
                    }, 
                    (error) =>
                    {
                        if (error.code == 1) alert("Allow to access your position.");
                        else alert("Unfortunately, your position could not be determined.");
                        reject("Failed");
                    });
                });
            }

            //coord -> [float, float], city -> City
            //returns float
            async function getNearestCityCenterDistance(coord, city)
            {
                var service = new google.maps.DistanceMatrixService();
                return await new Promise((resolve, reject) => 
                {
                    service.getDistanceMatrix(
                    {
                        origins: [new google.maps.LatLng(coord[0], coord[1])],
                        destinations: [city],
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.METRIC,
                        avoidHighways: false,
                        avoidTolls: false,
                    },
                    (response, status) =>
                    {
                        if (status === "OK") 
                        {
                            if(response.rows[0].elements[0].status === "OK") resolve(response.rows[0].elements[0].distance.value);
                            else resolve(NaN);
                        } 
                        else
                        {
                            console.log('Distance Matrix Service failed: ' + status);
                            reject("Failed");
                        }
                    })
                });
            }

            //coord -> [float, float]
            //returns float
            async function getEarthCenterDistance(x, z)
            {
                const a = 12742; //km
                const b = 12713; //km

                var exp1 = a^4 * (Math.cos(x))^2 + b^4 * (Math.sin(x))^2;
                var exp2 = a^2 * (Math.cos(x))^2 + b^2 * (Math.sin(x))^2;
                var exp3 = 2 * z * Math.sqrt(exp2);
                return exp1 / exp2 + exp3 + z^2;
            }

        </script>
        <script name="unitTests">

            const inCityCoords =  
            [ 
                ["Ankara", 39.942, 32.643], //rakım, şehir merkezine uzaklık, distancetoEC eklenecek
                ["İstanbul", 41.039, 28.978], 
                ["İzmir", 38.414, 27.149], 
                ["Adana", 37.026, 35.359], 
                ["New York", 40.695, -73.995], 
                ["London", 51.517, -0.136], 
                ["Berlin", 52.519, 13.409], 
                ["Moskva", 55.760, 37.628], 
                ["Hong Kong", 22.287, 114.167], 
                ["Sydney", -33.869, 151.214]
                //Aynı şehirde farklı noktalar eklenebilir
            ];

            const outCityCoords = 
            [
                ["North Atlantic Ocean", 33.953, -40.783, "None"],
                ["Sahara Desert", 22.794, 14.988, "Bilma"],
                ["Greenland", 65.874, -46.301, "Qeqqata Municipality"], 
                ["Mount Everest", 27.988, 86.922, "Rikaze Shi"], 
            ];

            function sleep(milliseconds) 
            {
                const date = Date.now();
                let currentDate = null;
                do 
                {
                    currentDate = Date.now();
                } 
                while (currentDate - date < milliseconds);
            }

            async function testGetCity()
            {
                let i = 0;
                while(i < inCityCoords.length) 
                {
                    let coord = inCityCoords[i];
                    try 
                    {
                        let city = await getCity([coord[1], coord[2]]);
                        console.assert(city === coord[0],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "InCityCoords getCity(): incorrect city"
                        });
                    } 
                    catch (error) 
                    {
                        console.log("InCityCoords getCity(): " + error);
                    }
                    sleep(2000);
                    i++;
                }

                i = 0;
                while(i < outCityCoords.length) 
                {
                    let coord = outCityCoords[i];
                    try 
                    {
                        let city = await getCity([coord[1], coord[2]]);
                        console.assert(city === coord[3],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "OutCityCoords getCity(): incorrect city"
                        });
                    } 
                    catch (error) 
                    {
                        console.log("OutCityCoords getCity(): " + error);
                    }
                    sleep(2000);
                    i++;
                }
            }

            async function testGetDeviceCoordinates()
            {
                try 
                {
                    let coords = await getDeviceCoordinates();
                    console.assert(coords[0] >= -90.0 && coords[0] <= 90.0 && coords[1] >= -180.0 && coords[1] <= 180.0, 
                    {
                        xCoord: coords[0], 
                        yCoord: coords[1], 
                        error: "getDeviceCoordinates(): -90.0 <= x <= 90.0, -180.0 <= y <= 180.0"
                    }); 
                }
                catch(error)
                { 
                    console.log("getDeviceCoordinates(): " + error);
                }
                //sleep(2000);
            }

            async function testGetNearestCityCenterDistance()
            {
                let i = 0;
                while(i < inCityCoords.length) 
                {
                    let coord = inCityCoords[i];
                    try 
                    {
                        let distance = await getNearestCityCenterDistance([coord[1], coord[2]], coord[0]);
                        console.assert(distance === coord[0],
                        {
                            coord: coord.toString(),
                            distance: distance,
                            error: "InCityCoords getNearestCityCenterDistance(): incorrect distance"
                        });
                    } 
                    catch (error) 
                    {
                        console.log("InCityCoords getNearestCityCenterDistance(): " + error);
                    }
                    //sleep(2000);
                    i++;
                }

                i = 0;
                while(i < outCityCoords.length) 
                {
                    let coord = outCityCoords[i];
                    try 
                    {
                        let distance = await getNearestCityCenterDistance([coord[1], coord[2]], coord[3]);
                        console.assert(distance === coord[0],
                        {
                            coord: coord.toString(),
                            distance: distance,
                            error: "OutCityCoords getNearestCityCenterDistance(): incorrect distance"
                        });
                    } 
                    catch (error) 
                    {
                        console.log("OutCityCoords getNearestCityCenterDistance(): " + error);
                    }
                    //sleep(2000);
                    i++;
                }
            }

            async function testGetEarthCenterDistance()
            {
                inCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance === coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "InCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });

                outCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance != coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "OutCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });
            }

            async function unitTest()
            {
                //await testGetDeviceCoordinates();
                //await testGetCity();
                await testGetNearestCityCenterDistance();
                //await testGetEarthCenterDistance();
            }

        </script>
        <style type="text/css">
            /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
            #map { height: 100%; }

            /* Optional: Makes the sample page fill the window. */
            html, body { height: 100%; margin: 0; padding: 0; }
        </style>
        <script>

            let map;
            let geocoder;
        
            async function initPage() 
            {
                map = new google.maps.Map(document.getElementById("map"), 
                {
                    center: { lat: 39.942, lng: 32.643 },
                    zoom: 10,
                });
                geocoder = new google.maps.Geocoder();
                await unitTest();
            }

        </script>
        <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAjZAFTWtoDNnapPo5LNv4ziRS8WjKPQM&callback=initPage&libraries=&v=weekly"></script>
    </head>
    <body>
        <div id="CoordinateInput">
            <form action="javascript:void(0);" onsubmit="getCity()">
                <label for="xCoord">Latitude: </label>
                <input class="coordInput" type="number" name="xCoord" pattern="[0-9]+([.,][0-9]+)?" required min="-90.0" max="90.0"><br>
                <label for="yCoord">Longitude: </label>
                <input class="coordInput" type="number" name="yCoord" pattern="[0-9]+([.,][0-9]+)?" required min="-180.0" max="180.0"><br>
                <button type="submit">OK</button>
            </form>
        </div>
        <div id="map"></div>
    </body>
</html>
