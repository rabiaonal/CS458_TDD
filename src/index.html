<html>
    <head>
        <style type="text/css">
            /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
            #map { height: 100%; }

            /* Optional: Makes the sample page fill the window. */
            html, body { height: 100%; margin: 0; padding: 0; }
        </style>
        <script>

            let map;
            let geocoder;
        
            function initPage() 
            {
                map = new google.maps.Map(document.getElementById("map"),
                {
                    center: new google.maps.LatLng(39.942, 32.643),
                    zoom: 10
                });
                geocoder = new google.maps.Geocoder();
                //unitTest();
            }

        </script>
    </head>
    <body>
        <p id="CoordinateInput">
            <form action="javascript:void(0);">
                <label id="xCoord">Latitude: </label>
                <input class="coordInput" type="number" name="xCoord" id="xCoordIn" pattern="[0-9]+([.,][0-9]+)?" required min="-90.0" max="90.0"><br>
                <label id="yCoord">Longitude: </label>
                <input class="coordInput" type="number" name="yCoord" id="yCoordIn" pattern="[0-9]+([.,][0-9]+)?" required min="-180.0" max="180.0"><br>
                <button type="submit" onclick="calculate()">OK</button>
            </form>
            <button onclick="getFromGPS()">Get from GPS</button> <br>
            <p id="city"></p>
            <p id="distanceToCity"></p>
            <p id="distanceToEarth"></p>
        </div>
        <div id="map"></div>
        <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAjZAFTWtoDNnapPo5LNv4ziRS8WjKPQM&callback=initPage&libraries=&v=weekly"></script>
        <script>

            function getFromGPS() {
                getDeviceCoordinates().then(coord => {
                    document.getElementById("xCoordIn").value = coord[0].toFixed(6);
                    document.getElementById("yCoordIn").value = coord[1].toFixed(6);
                });
            }

            function calculate(){
                var x = parseFloat(document.getElementById("xCoordIn").value);
                var y = parseFloat(document.getElementById("yCoordIn").value);
                getCity(x, y).then(city => {
                    document.getElementById("city").innerText = "You are in " + city + ".";
                    document.getElementById("distanceToEarth").innerText = "You are " + getEarthCenterDistance(x, 0) + " km away from the center of the earth.";
                    getNearestCityCenterDistance(x, y).then( distance => {
                        document.getElementById("distanceToCity").innerText = "You are" + distance + " km away from the city center.";
                        getEarthCenterDistance(x, y);
                    });
                });
            }

            //coord -> [float, float]
            //returns City
            function getCity(x, y)
            {
                const latlng = new google.maps.LatLng(x, y);
                   
                let cityPromise = new Promise((resolve, reject) =>
                {
                    geocoder.geocode( {location : latlng}, (results, status) => 
                    {
                        if(status === 'OK') 
                        {
                            map.setCenter(results[0].geometry.location);
                            for(i = 0; i < results[0].address_components.length; i++){
                                if(results[0].address_components[i].types.includes("administrative_area_level_1"))
                                {
                                    var marker = new google.maps.Marker( {
                                        map: map, position: results[0].geometry.location });
                                    resolve(results[0].address_components[i].long_name);
                                    return;
                                }
                            }
                            var marker = new google.maps.Marker( {
                                map: map, position: results[0].geometry.location });
                            resolve("None");
                        } 
                        else 
                        {
                            alert('Geocode failed: ' + status);
                            reject('Failed');
                        }
                    });
                });
                return cityPromise;
            }

            //returns Promise<[float, float]>
            function getDeviceCoordinates()
            {
                return new Promise((resolve, reject) => 
                {
                    navigator.geolocation.getCurrentPosition((location) => 
                    {
                        resolve([location.coords.latitude, location.coords.longitude]);
                    }, 
                    (error) =>
                    {
                        if (error.code === 1) alert("Allow to access your position.");
                        else alert("Unfortunately, your position could not be determined.");
                        reject([NaN, NaN]);
                    });
                });
            }

            //coord -> [float, float]
            //returns float
            function  getNearestCityCenterDistance(x, y)
            {
                var service = new google.maps.DistanceMatrixService();
                return new Promise((resolve, reject) => {
                    service.getDistanceMatrix(
                        {
                            origins: new google.maps.LatLng(x, y),
                            destinations: document.getElementById("city").innerText,
                            travelMode: google.maps.TravelMode.DRIVING,
                            unitSystem: google.maps.UnitSystem.METRIC,
                            avoidHighways: false,
                            avoidTolls: false,
                        }, function(response, status){
                            if (status === "OK") {
                                resolve(response);
                            } else {
                                reject(status);
                            }
                        }
                    )
                });

            }

            //coord -> [float, float]
            //returns float
            function getEarthCenterDistance(x, z)
            {
                //z şu an 0 veriliyor aslında apidan alınacak
                const a = 6378; //km
                const b = 6356; //km
                const xRad = x * Math.PI / 180;

                var exp1 = Math.pow(a,4) * Math.pow(Math.cos(xRad), 2) + Math.pow(b, 4) * Math.pow(Math.sin(xRad), 2);
                var exp2 = Math.pow(a,2) * Math.pow(Math.cos(xRad), 2) + Math.pow(b, 2) * Math.pow(Math.sin(xRad), 2);
                var exp3 = 2 * z * Math.sqrt(exp2);
                return Math.sqrt(exp1 / exp2 + exp3 + Math.pow(z,2)).toFixed(2);
            }

        </script>
        <script id="unitTests">

            const inCityCoords =  
            [ 
                ["Ankara", 39.942, 32.643], //rakım, şehir merkezine uzaklık, distancetoEC eklenecek
                ["İstanbul", 41.039, 28.978], 
                ["İzmir", 38.414, 27.149], 
                ["Adana", 37.026, 35.359], 
                ["New York", 40.695, -73.995], 
                ["London", 51.517, -0.136], 
                ["Berlin", 52.519, 13.409], 
                ["Moscow", 55.760, 37.628], 
                ["Hong Kong", 22.287, 114.167], 
                [ "Sydney", -33.869, 151.214]
                //Aynı şehirde farklı noktalar eklenebilir
            ];

            const outCityCoords = 
            [
                ["North Atlantic Ocean", 33.953, -40.783],
                ["North Pasific Ocean", 30.102, -171.692], 
                ["Sahara Desert", 22.794, 14.988],
                ["Greenland", 65.874, -46.301], 
                ["Mount Everest", 27.988, 86.922], 
            ];

            function testGetCity()
            {
                inCityCoords.forEach(coord => 
                {
                    getCity([coord[1], coord[2]]).then((city) => 
                    {
                        console.assert(city === coord[0],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "InCityCoords getCity(): incorrect city"
                        });
                    }); 
                });

                outCityCoords.forEach(coord => 
                {
                    getCity([coord[1], coord[2]]).then((city) => 
                    {
                        console.assert(city === coord[0],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "OutCityCoords getCity(): incorrect city"
                        });
                    }); 
                });
            }

            function testGetDeviceCoordinates()
            {
                function assert(coords) 
                {
                    console.assert(coords[0] >= -90.0 && coords[0] <= 90.0 && coords[1] >= -180.0 && coords[1] <= 180.0, 
                    {
                        xCoord: coords[0], 
                        yCoord: coords[1], 
                        error: "getDeviceCoordinates(): -90.0 <= x <= 90.0, -180.0 <= y <= 180.0"
                    });
                }
                getDeviceCoordinates().then((coords) => { assert(coords); }).catch((coords) => { assert(coords); });
            }

            function testGetNearestCityCenterDistance()
            {
                inCityCoords.forEach(coord => 
                {
                    let distance = getNearestCityCenterDistance([coord[1], coord[2]]);
                    console.assert(distance === coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "InCityCoords getNearestCityCenterDistance(): incorrect distance"
                    });
                });

                outCityCoords.forEach(coord => 
                {
                    let distance = getNearestCityCenterDistance([coord[1], coord[2]]);
                    console.assert(distance !== coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "OutCityCoords getNearestCityCenterDistance(): incorrect distance"
                    });
                });
            }

            function testGetEarthCenterDistance()
            {
                inCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance === coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "InCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });

                outCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance !== coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "OutCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });
            }

            function unitTest()
            {
                testGetDeviceCoordinates();
                testGetCity();
                testGetNearestCityCenterDistance();
                testGetEarthCenterDistance();
            }

        </script>
    </body>
</html>
