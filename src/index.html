<html>
    <head>
        <style type="text/css">
            /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
            #map { height: 100%; }

            /* Optional: Makes the sample page fill the window. */
            html, body { height: 100%; margin: 0; padding: 0; }
        </style>
        <script>

            let map;
            let geocoder;
        
            function initPage() 
            {
                map = new google.maps.Map(document.getElementById("map"), 
                {
                    center: { lat: 39.942, lng: 32.643 },
                    zoom: 10,
                });
                geocoder = new google.maps.Geocoder();
                unitTest();
            }

        </script>
    </head>
    <body>
        <div id="CoordinateInput">
            <form action="javascript:void(0);" onsubmit="getCity()">
                <label for="xCoord">Latitude: </label>
                <input class="coordInput" type="number" name="xCoord" pattern="[0-9]+([.,][0-9]+)?" required min="-90.0" max="90.0"><br>
                <label for="yCoord">Longitude: </label>
                <input class="coordInput" type="number" name="yCoord" pattern="[0-9]+([.,][0-9]+)?" required min="-180.0" max="180.0"><br>
                <button type="submit">OK</button>
            </form>
        </div>
        <div id="map"></div>
        <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAjZAFTWtoDNnapPo5LNv4ziRS8WjKPQM&callback=initPage&libraries=&v=weekly"></script>
        <script>

            //coord -> [float, float]
            //returns City
            function getCity(coords)
            {
                const latlng = 
                {
                    lat: coords[0],
                    lng: coords[1],
                };
                   
                let cityPromise = new Promise((resolve, reject) =>
                {
                    geocoder.geocode( {location : latlng}, (results, status) => 
                    {
                        if(status === 'OK') 
                        {
                            map.setCenter(results[0].geometry.location);
                            for(i = 0; i < results[0].address_components.length; i++){
                                if(results[0].address_components[i].types.includes("administrative_area_level_1"))
                                {
                                    var marker = new google.maps.Marker( {
                                        map: map, position: results[0].geometry.location });
                                    resolve(results[0].address_components[i].long_name);
                                    return;
                                }
                            }
                            var marker = new google.maps.Marker( {
                                map: map, position: results[0].geometry.location });
                            resolve("None");
                        } 
                        else 
                        {
                            alert('Geocode failed: ' + status);
                            reject('Failed');
                        }
                    });
                });
                return cityPromise;
            }

            //returns Promise<[float, float]>
            function getDeviceCoordinates()
            {
                return new Promise((resolve, reject) => 
                {
                    navigator.geolocation.getCurrentPosition((location) => 
                    {
                        resolve([location.coords.latitude, location.coords.longitude]);
                    }, 
                    (error) =>
                    {
                        if (error.code == 1) alert("Allow to access your position.");
                        else alert("Unfortunately, your position could not be determined.");
                        reject([NaN, NaN]);
                    });
                });
            }

            //coord -> [float, float]
            //returns float
            function  getNearestCityCenterDistance(coord)
            {
                return NaN;
            }

            //coord -> [float, float]
            //returns float
            function getEarthCenterDistance(x, z)
            {
                const a = 12742; //km
                const b = 12713; //km

                var exp1 = a^4 * (Math.cos(x))^2 + b^4 * (Math.sin(x))^2;
                var exp2 = a^2 * (Math.cos(x))^2 + b^2 * (Math.sin(x))^2;
                var exp3 = 2 * z * Math.sqrt(exp2);
                return exp1 / exp2 + exp3 + z^2;
            }

        </script>
        <script name="unitTests">

            const inCityCoords =  
            [ 
                ["Ankara", 39.942, 32.643], //rakım, şehir merkezine uzaklık, distancetoEC eklenecek
                ["İstanbul", 41.039, 28.978], 
                ["İzmir", 38.414, 27.149], 
                ["Adana", 37.026, 35.359], 
                ["New York", 40.695, -73.995], 
                ["London", 51.517, -0.136], 
                ["Berlin", 52.519, 13.409], 
                ["Moscow", 55.760, 37.628], 
                ["Hong Kong", 22.287, 114.167], 
                [ "Sydney", -33.869, 151.214]
                //Aynı şehirde farklı noktalar eklenebilir
            ];

            const outCityCoords = 
            [
                ["North Atlantic Ocean", 33.953, -40.783],
                ["North Pasific Ocean", 30.102, -171.692], 
                ["Sahara Desert", 22.794, 14.988],
                ["Greenland", 65.874, -46.301], 
                ["Mount Everest", 27.988, 86.922], 
            ];

            function testGetCity()
            {
                inCityCoords.forEach(coord => 
                {
                    getCity([coord[1], coord[2]]).then((city) => 
                    {
                        console.assert(city === coord[0],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "InCityCoords getCity(): incorrect city"
                        });
                    }); 
                });

                outCityCoords.forEach(coord => 
                {
                    getCity([coord[1], coord[2]]).then((city) => 
                    {
                        console.assert(city === coord[0],
                        {
                            coord: coord.toString(),
                            city: city,
                            error: "OutCityCoords getCity(): incorrect city"
                        });
                    }); 
                });
            }

            function testGetDeviceCoordinates()
            {
                function assert(coords) 
                {
                    console.assert(coords[0] >= -90.0 && coords[0] <= 90.0 && coords[1] >= -180.0 && coords[1] <= 180.0, 
                    {
                        xCoord: coords[0], 
                        yCoord: coords[1], 
                        error: "getDeviceCoordinates(): -90.0 <= x <= 90.0, -180.0 <= y <= 180.0"
                    });
                }
                getDeviceCoordinates().then((coords) => { assert(coords); }).catch((coords) => { assert(coords); });
            }

            function testGetNearestCityCenterDistance()
            {
                inCityCoords.forEach(coord => 
                {
                    let distance = getNearestCityCenterDistance([coord[1], coord[2]]);
                    console.assert(distance === coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "InCityCoords getNearestCityCenterDistance(): incorrect distance"
                    });
                });

                outCityCoords.forEach(coord => 
                {
                    let distance = getNearestCityCenterDistance([coord[1], coord[2]]);
                    console.assert(distance != coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "OutCityCoords getNearestCityCenterDistance(): incorrect distance"
                    });
                });
            }

            function testGetEarthCenterDistance()
            {
                inCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance === coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "InCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });

                outCityCoords.forEach(coord => 
                {
                    let distance = getEarthCenterDistance([coord[1], coord[2]]);
                    console.assert(distance != coord[0],
                    {
                        coord: coord.toString(),
                        distance: distance,
                        error: "OutCityCoords getEarthCenterDistance(): incorrect distance"
                    });
                });
            }

            function unitTest()
            {
                testGetDeviceCoordinates();
                testGetCity();
                testGetNearestCityCenterDistance();
                testGetEarthCenterDistance();
            }

        </script>
    </body>
</html>
